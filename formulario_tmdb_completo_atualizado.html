
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Formulário Completo TMDb</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e7eef9;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.15);
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      margin-bottom: 20px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #125ac4;
    }
    #sugestoes {
      background: #f2f6ff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    .sugestao {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }
    .sugestao:hover {
      background-color: #dbe9ff;
    }
    .preview {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .preview img {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      cursor: zoom-in;
    }
    #modal {
      position: fixed;
      display: none;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Formulário Completo TMDb</h2>
    <input type="text" id="busca" placeholder="Buscar série ou filme..." />
    <div id="sugestoes"></div>

    <div class="preview" id="preview" style="display:none;">
      <img id="capaPreview" src="" alt="Capa" />
      <div>
        <p><strong id="tituloSelecionado"></strong></p>
      </div>
    </div>

    <form id="formulario">
      <input type="hidden" id="nomePesquisado" />
      <input type="hidden" id="imagemUrl" />
      <input type="hidden" id="tipoSelecionado" />
      <input type="hidden" id="tmdbId" />

      <label for="temporada">Temporada:</label>
      <select id="temporada" disabled>
        <option value="">Selecione</option>
      </select>

      <label for="episodio">Episódio:</label>
      <select id="episodio" disabled>
        <option value="">Selecione</option>
      </select>

      <label for="operacao">Operação:</label>
      <select id="operacao">
        <option value="">Selecione</option>
      </select>

      <label for="nomeCliente">Nome do Cliente:</label>
      <input type="text" id="nomeCliente" required />

      <label for="contato">Contato:</label>
      <input type="text" id="contato" required />

      <button type="submit">Salvar</button>
    </form>
  </div>

  <div id="modal"><img src="" id="modalImg" /></div>

  <script>
    const apiKey = '702538c6d203831e3ab031534f4a2d0e';
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbwtNrhUbRxKY5QbsWL8pimLeBi-K6CbZjpvGqfr9iYPD8XHloNj8NsMCyFXeqFgKKU0/exec';

    const busca = document.getElementById('busca');
    const sugestoesEl = document.getElementById('sugestoes');
    const preview = document.getElementById('preview');
    const capaPreview = document.getElementById('capaPreview');
    const tituloSelecionado = document.getElementById('tituloSelecionado');
    const modal = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const nomePesquisado = document.getElementById('nomePesquisado');
    const imagemUrl = document.getElementById('imagemUrl');
    const tipoSelecionado = document.getElementById('tipoSelecionado');
    const tmdbId = document.getElementById('tmdbId');
    const temporadaEl = document.getElementById('temporada');
    const episodioEl = document.getElementById('episodio');
    const operacaoEl = document.getElementById('operacao');

    busca.addEventListener('input', async () => {
      const query = busca.value.trim();
      if (query.length < 2) {
        sugestoesEl.innerHTML = '';
        return;
      }
      const res = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${apiKey}&language=pt-BR&query=${encodeURIComponent(query)}`);
      const data = await res.json();
      sugestoesEl.innerHTML = '';
      data.results.forEach(item => {
        if (item.media_type === 'movie' || item.media_type === 'tv') {
          const nome = item.title || item.name;
          const poster = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : '';
          const div = document.createElement('div');
          div.className = 'sugestao';
          div.textContent = nome;
          div.onclick = () => selecionarItem(nome, poster, item.media_type, item.id);
          sugestoesEl.appendChild(div);
        }
      });
    });

    async function selecionarItem(nome, poster, tipo, id) {
      nomePesquisado.value = nome;
      imagemUrl.value = poster;
      tipoSelecionado.value = tipo;
      tmdbId.value = id;
      tituloSelecionado.textContent = nome;
      capaPreview.src = poster;
      preview.style.display = 'flex';
      sugestoesEl.innerHTML = '';
      busca.value = nome;
      operacaoEl.innerHTML = '<option value="">Selecione</option>';
      operacaoEl.innerHTML += '<option>adicionar</option><option>corrigir</option>';
      if (tipo === 'tv') {
        operacaoEl.innerHTML += '<option>atualizar</option>';
        temporadaEl.disabled = false;
        const r = await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${apiKey}&language=pt-BR`);
        const json = await r.json();
        temporadaEl.innerHTML = '<option value="">Selecione</option>';
        json.seasons.forEach(season => {
          temporadaEl.innerHTML += `<option value="${season.season_number}">${season.name}</option>`;
        });
      } else {
        temporadaEl.disabled = true;
        episodioEl.disabled = true;
        temporadaEl.innerHTML = '<option value="">Selecione</option>';
        episodioEl.innerHTML = '<option value="">Selecione</option>';
      }
    }

    temporadaEl.addEventListener('change', async () => {
      const id = tmdbId.value;
      const temporada = temporadaEl.value;
      if (!temporada) return;
      episodioEl.disabled = false;
      const res = await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${temporada}?api_key=${apiKey}&language=pt-BR`);
      const json = await res.json();
      episodioEl.innerHTML = '<option value="">Selecione</option>';
      json.episodes.forEach(ep => {
        episodioEl.innerHTML += `<option value="${ep.episode_number}">${ep.episode_number} - ${ep.name}</option>`;
      });
    });

    capaPreview.onclick = () => {
      modal.style.display = 'flex';
      modalImg.src = capaPreview.src;
    };
    modal.onclick = () => {
      modal.style.display = 'none';
      modalImg.src = '';
    };

    document.getElementById('formulario').addEventListener('submit', async (e) => {
      e.preventDefault();
      const dados = {
        nomePesquisado: nomePesquisado.value,
        nomeCliente: document.getElementById('nomeCliente').value,
        contato: document.getElementById('contato').value,
        imagemUrl: imagemUrl.value,
        temporada: temporadaEl.value || '',
        episodio: episodioEl.value || '',
        operacao: operacaoEl.value || ''
      };
      const res = await fetch(webAppUrl, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(dados)
      });
      const json = await res.json();
      if (json.status === 'ok') {
        alert('Dados salvos com sucesso!');
        document.getElementById('formulario').reset();
        preview.style.display = 'none';
        busca.value = '';
      } else {
        alert('Erro: ' + json.message);
      }
    });
  </script>

</body>
</html>
